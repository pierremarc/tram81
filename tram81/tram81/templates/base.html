<html>
<head>
<title>test</title>
<style>

#map{
    width:100%;
    height:100%;
}

</style>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->

<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
<script src="{{STATIC_URL}}zepto.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<!-- <script src="{{STATIC_URL}}tram81.js"></script> -->
<script>

{% autoescape off %}
window.T81 = {};
window.T81.config = {
    TILE_SERVER: '{{TILE_SERVER}}',
};
window.T81.data = [
{% for image in images %}
{
    url: '{{ image.image.url }}',
    geo: JSON.parse('{{ image.geom.geojson }}'),
    txt: '{{ image.text|escapejs }}',
    pub: new Date('{{ image.pub_date|date:"c" }}'),
},
{% endfor %}
];

{% endautoescape %}
Zepto(function($){

    var $map = $('#map');
    var map = L.map('map').setView([50.854075572144815, 4.38629150390625], 13);
    L.tileLayer(window.T81.config.TILE_SERVER, {
        attribution: 'Me',
        maxZoom: 28
    }).addTo(map);
    
//     L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
//     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
// }).addTo(map);
//     
    function px(i){
        return i + 'px';
    };
    
    function mapElement(layer, append){
        var bounds = layer.getBounds();
        var $el = layer.$data_content;
        $el.detach();
        var NW = map.latLngToContainerPoint(bounds.getNorthWest());
        var SE = map.latLngToContainerPoint(bounds.getSouthEast());
        
        var bb = new L.Bounds(NW, SE);
        $el.css({
            position:'absolute',
            top:px(bb.min.y),
            left:px(bb.min.x),
            width:px(bb.getSize().x),
            height:px(bb.getSize().y),
        });
        $map.append($el);
    };
    
    var cur_idx = undefined;
    var images = [];
    function createLayer(data, idx){
        var l = new L.geoJson(data.geo,{
            style: function (feature) {
                return {
                    fill:true,
                    fillOpacity:0.0,
                    stroke:false,
                    clickable:true,
                    };
            },
        });
        var $img =  $('<img />');
        $img.css({
            width:'100%',
            height:'100%',
        });
        $img.attr('src', data.url);
        l.data_idx = idx;
        l.$data_content = $('<div />');
        l.$data_content.append($img);
        l.addTo(map);
        l.on('mouseover', function(evt){
            if(cur_idx === this.$data_content)
            {
                return;
            }
            if(cur_idx)
            {
            TODO
                _.each(map_events, function(ename){
                map.off(ename, function(evt){mapElement(cur_idx);})
                cur_idx.detach();
            });
            }
            cur_idx = this.$data_content;
            mapElement(this);
            var that = this;
            var map_events = 'move resize zoomstart dragstart'.split(' ');
            _.each(map_events, function(ename){
                map.on(ename, function(evt){mapElement(that);})
            });
        });
        
//         var rects = [];
//         function debug(){
//             var first_base = undefined;
//             var zoom = map.getZoom();
//              _.each(rects, function(R){
//                 map.removeLayer(R);
//              });
//              rects = [];
//             $.getJSON('http://tram81.localdomain/api/image/debug/12/'+zoom, function(data){
//                 _.each(data.data, function(bnd, idx){
//                     var southWest = new L.LatLng(bnd.bounds.miny, bnd.bounds.minx),
//                         northEast = new L.LatLng(bnd.bounds.maxy, bnd.bounds.maxx);
//                     var llb = new L.LatLngBounds(southWest, northEast);
//                     if(!first_base)
//                     {
//                         first_base = llb;
//                     }
//                     else
//                     {
//                         first_base.extend(llb);
//                     }
//                     if(idx + 1 >= data.data.length)
//                     {
//     //                     map.fitBounds(first_base);
//                     }
// //                     if(parseInt(bnd.z) !== zoom)
// //                     {
// //                         return;
// //                     }
// //                     console.log(llb.toBBoxString());
//                     var col = bnd.damaged ? "#ff0000":'#0000ff';
//                     var b = new L.rectangle(llb, {
//                                     color: col, 
//                                     weight: 1,
//                                     fill:true,
//                                     fillColor:col,
//                                     });
//                     b.bindPopup(bnd.key);
//                         b.addTo(map);
//                     rects.push(b);
//                     
//                 });
//                 
//                 var southWest = new L.LatLng(data.base.miny, data.base.minx),
//                         northEast = new L.LatLng(data.base.maxy, data.base.maxx);
//                     var llb = new L.LatLngBounds(southWest, northEast);
//                 var b = new L.rectangle(llb, {
//                                     color: "#00ff00", 
//                                     weight: 1,
//                                     fill:true,
//                                     fillColor:"#00ff00",
//                                     });
//                         b.addTo(map);
//                     rects.push(b);
//             });
//         };
//         debug();
//         map.on('zoomend', debug);
//         l.on('mouseout', function(evt){
//         console.log('OUT', cur_idx);
//             cur_idx = -1;
//             this.$data_content.detach();
//         });
    };
    _.each(window.T81.data, createLayer);

});

</script>
</head>

<body>
<!-- <img src="test.png"  id="img"></img> -->
<div id="map"></div>
</body>
</html>